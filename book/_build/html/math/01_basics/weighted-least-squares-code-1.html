
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>WLS - Code Examples Part 1 &#8212; Quantopia&#39;:&#39; Physics, Python and Pi</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'math/01_basics/weighted-least-squares-code-1';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Goodness of Fit and Chi-Squared Statistic" href="goodness-of-fit-and-chi-squared.html" />
    <link rel="prev" title="Weighted Least Squares" href="weighted-least-squares.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Quantopia':' Physics, Python and Pi - Home"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Quantopia':' Physics, Python and Pi - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Quantopia: Physics, Python, and Pi (Alpha Version)
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">MATH</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="gradient-operator.html">Gradient</a></li>
<li class="toctree-l1"><a class="reference internal" href="gradient-directional-derivative.html">Directional Derivative</a></li>
<li class="toctree-l1"><a class="reference internal" href="divergence.html">Divergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="fourier-transform-01.html">Fourier Transform</a></li>
<li class="toctree-l1"><a class="reference internal" href="least-squares-regression.html">Least Squares Regression, RSS, RMSE, R-squared</a></li>
<li class="toctree-l1"><a class="reference internal" href="least-squares-regression-code.html">Least Squares Regression - Code Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="ordinary-least-squares.html">Ordinary Least Squares (OLS) Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="ordinary-least-squares-code.html">Ordinary Least Squares (OLS) Regression - Code Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="variance-covariance.html">Variance and Covariance</a></li>
<li class="toctree-l1"><a class="reference internal" href="weighted-least-squares.html">Weighted Least Squares</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">WLS - Code Examples Part 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="goodness-of-fit-and-chi-squared.html">Goodness of Fit and Chi-Squared Statistic</a></li>
<li class="toctree-l1"><a class="reference internal" href="aic-and-bic.html">Akaike Information Criterion (AIC) and Bayesian Information Criterion (BIC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="weighted-least-squares-code-2.html">WLS - Code Examples Part 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="orthogonal-distance-regression.html">Orthogonal Distance Regression</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">PHYSICS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../physics/continuity-equation-01.html">The Continuity Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../physics/continuity-equation-02.html">The Continuity Equation: One-Dimensional Advection of a Density Profile</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../physics/ensemble.html">Statistical Ensembles and Liouville’s Theorem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../physics/microcanonical-ensemble.html">Microcanonical Ensemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../physics/fokker-planck-equation-example.html">Fokker-Planck Equation - Example Analysis (preview)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">DATA SCIENCE AND MACHINE LEARNING</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../data-science/knn-algorithm.html">K-Nearest Neighbors (KNN) Algorithm (preview)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data-science/naive-bayes.html">Naive Bayes Method (preview)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data-science/logistic-regression.html">Logistic Regression (preview)</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/Yakovliev/quantopia/blob/main/book/math/01_basics/weighted-least-squares-code-1.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/Yakovliev/quantopia" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Yakovliev/quantopia/issues/new?title=Issue%20on%20page%20%2Fmath/01_basics/weighted-least-squares-code-1.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/math/01_basics/weighted-least-squares-code-1.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>WLS - Code Examples Part 1</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-note-on-estimating-weights-when-true-variance-is-unknown">A Note on Estimating Weights When True Variance is Unknown</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-multi-step-procedure-for-estimating-weights-for-linear-problem">The Multi-Step Procedure for Estimating Weights for Linear Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-modeling-household-spending">Example: Modeling Household Spending</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-we-don-t-use-a-single-ser">Why We Don’t Use a Single SER</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-materials">Additional Materials</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#code-example-1">Code Example 1</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-intercept-term-in-linear-regression">The Intercept Term in Linear Regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-sm-add-constant-works">How <code class="docutils literal notranslate"><span class="pre">sm.add_constant</span></code> Works</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#perform-an-initial-ols-regression">Perform an Initial OLS Regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#output-analysis">Output Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-t-statistic-t">The t-statistic (<span class="math notranslate nohighlight">\(t\)</span>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-p-value-p-t">The P-value (<span class="math notranslate nohighlight">\(P&gt;|t|\)</span>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-confidence-interval-0-025-0-975">The Confidence Interval ([0.025 0.975])</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-weights-from-ols-residuals">Estimate Weights from OLS Residuals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#perform-the-final-wls-regression">Perform the Final WLS Regression</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2">Example 2</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3">Example 3</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="wls-code-examples-part-1">
<h1>WLS - Code Examples Part 1<a class="headerlink" href="#wls-code-examples-part-1" title="Link to this heading">#</a></h1>
<section id="a-note-on-estimating-weights-when-true-variance-is-unknown">
<h2>A Note on Estimating Weights When True Variance is Unknown<a class="headerlink" href="#a-note-on-estimating-weights-when-true-variance-is-unknown" title="Link to this heading">#</a></h2>
<p>In experimental sciences, you may know the uncertainty (<span class="math notranslate nohighlight">\(\sigma_i\)</span>) for each measurement from the specifications of your instruments or from repeated measurements. However, in many other fields, such as econometrics or the social sciences, the true error variances (<span class="math notranslate nohighlight">\(\sigma_i^2\)</span>) are not known. When you detect heteroscedasticity - for example, by seeing a “fan” or “megaphone” shape in a plot of your model’s residuals - you cannot simply ignore it.</p>
<p>In these situations, you must estimate the weights from the data itself. This data-driven approach is often called <strong>Feasible Generalized Least Squares (FGLS)</strong> or, more specifically for our case, two-stage WLS. The process provides a robust way to obtain more efficient and reliable parameter estimates.</p>
<section id="the-multi-step-procedure-for-estimating-weights-for-linear-problem">
<h3>The Multi-Step Procedure for Estimating Weights for Linear Problem<a class="headerlink" href="#the-multi-step-procedure-for-estimating-weights-for-linear-problem" title="Link to this heading">#</a></h3>
<p>Here is a common and practical procedure to estimate the weights and perform a WLS regression.</p>
<ol class="arabic simple">
<li><p><strong>Perform an Initial OLS Regression:</strong></p>
<ul class="simple">
<li><p>First, run a standard Ordinary Least Squares (OLS) regression on your data: <span class="math notranslate nohighlight">\(y = f(x, \beta) + \epsilon\)</span>.</p></li>
<li><p>OLS gives unbiased and consistent parameter estimates even when heteroscedasticity is present, so it serves as a valid starting point.</p></li>
</ul>
</li>
<li><p><strong>Analyze the Residuals to Model the Variance:</strong></p>
<ul class="simple">
<li><p>Obtain the residuals (<span class="math notranslate nohighlight">\(e_i = y_i - \hat{y}_i\)</span>) from the OLS fit.</p></li>
<li><p>Since raw squared residuals (<span class="math notranslate nohighlight">\(e_i^2\)</span>) can be very noisy estimates of variance, it is better to model the variance as a function of the predictors or the fitted values.</p></li>
<li><p>To do this, you regress a transformation of the residuals on the variable you believe is driving the heteroscedasticity. A common choice is to use the absolute residuals (<span class="math notranslate nohighlight">\(|e_i|\)</span>) as a proxy for the standard deviation (<span class="math notranslate nohighlight">\(\sigma_i\)</span>) or the squared residuals (<span class="math notranslate nohighlight">\(e_i^2\)</span>) as a proxy for the variance (<span class="math notranslate nohighlight">\(\sigma_i^2\)</span>). Using absolute residuals is often more robust to outliers.</p></li>
</ul>
</li>
<li><p><strong>Calculate the Weights:</strong></p>
<ul class="simple">
<li><p>The fitted values from the regression in Step 2 give you the estimated standard deviations (<span class="math notranslate nohighlight">\(\hat{\sigma}_i\)</span>) or variances (<span class="math notranslate nohighlight">\(\hat{\sigma}_i^2\)</span>) for each observation.</p></li>
<li><p>You then calculate the weight for each observation as the inverse of the estimated variance: <span class="math notranslate nohighlight">\(w_i = 1 / \hat{\sigma}_i^2\)</span>.</p></li>
</ul>
</li>
<li><p><strong>Perform the Final WLS Regression:</strong></p>
<ul class="simple">
<li><p>Rerun the original regression from Step 1, but this time apply the calculated weights (<span class="math notranslate nohighlight">\(w_i\)</span>) to each observation. This final fit is the Weighted Least Squares regression. The resulting parameter estimates will be more efficient, and their standard errors will be more reliable.</p></li>
</ul>
</li>
</ol>
</section>
<section id="example-modeling-household-spending">
<h3>Example: Modeling Household Spending<a class="headerlink" href="#example-modeling-household-spending" title="Link to this heading">#</a></h3>
<p>Let’s walk through a conceptual example to make this procedure clear.</p>
<p>Imagine you are a data scientist modeling a household’s annual spending (<span class="math notranslate nohighlight">\(y\)</span>) based on its annual income (<span class="math notranslate nohighlight">\(x\)</span>). Your hypothesis is that <span class="math notranslate nohighlight">\(y = \beta_0 + \beta_1 x\)</span>.</p>
<ul>
<li><p><strong>Step 1: Initial OLS Fit</strong>
You collect data from 1,000 households and run an OLS regression. You get initial estimates for <span class="math notranslate nohighlight">\(\beta_0\)</span> and <span class="math notranslate nohighlight">\(\beta_1\)</span>.</p></li>
<li><p><strong>Step 2: Detect Heteroscedasticity and Model Variance</strong>
You plot the residuals (<span class="math notranslate nohighlight">\(e_i\)</span>) against the income (<span class="math notranslate nohighlight">\(x_i\)</span>). The plot looks like this:</p>
<p>You observe a classic “megaphone” shape: the spread of the residuals is much smaller for low-income households and much larger for high-income households. This indicates that variance is not constant.</p>
<p>You decide to model this variance. A reasonable assumption is that the standard deviation of spending is proportional to income. To estimate this relationship, you regress the absolute value of the residuals on income:
$<span class="math notranslate nohighlight">\(|e_i| = \gamma_0 + \gamma_1 \cdot \text{income}_i\)</span>$</p>
</li>
<li><p><strong>Step 3: Calculate Weights</strong>
From the regression in Step 2, you get the predicted (fitted) values for the absolute residuals, let’s call them <span class="math notranslate nohighlight">\(\hat{e}_{abs_i}\)</span>. These fitted values are your estimates for the standard deviation of each observation, so <span class="math notranslate nohighlight">\(\hat{\sigma}_i = \hat{e}_{abs_i}\)</span>.</p>
<p>The estimated variance for each observation is therefore <span class="math notranslate nohighlight">\(\hat{\sigma}_i^2 = (\hat{e}_{abs_i})^2\)</span>.</p>
<p>Now, you can calculate the weight for each household in your dataset:
$<span class="math notranslate nohighlight">\(w_i = \frac{1}{\hat{\sigma}_i^2} = \frac{1}{(\hat{e}_{abs_i})^2}\)</span>$
High-income households, which had large residuals, will get smaller weights. Low-income households, which had small residuals, will get larger weights.</p>
</li>
<li><p><strong>Step 4: Perform Final WLS Regression</strong>
Finally, you rerun your original model (<code class="docutils literal notranslate"><span class="pre">Spending</span> <span class="pre">~</span> <span class="pre">Income</span></code>) but instruct your statistical software to use the weights (<span class="math notranslate nohighlight">\(w_i\)</span>) you just calculated. The new WLS model will minimize the weighted sum of squared residuals. The resulting estimates for the effect of income on spending will be more efficient, and the confidence intervals will be more accurate than what the initial OLS model provided.</p></li>
</ul>
</section>
<section id="why-we-don-t-use-a-single-ser">
<h3>Why We Don’t Use a Single SER<a class="headerlink" href="#why-we-don-t-use-a-single-ser" title="Link to this heading">#</a></h3>
<p>The <strong>Standard Error of the Regression (SER)</strong>, which is the square root of the estimated error variance, is an estimate of a single, constant <span class="math notranslate nohighlight">\(\sigma\)</span>. The formula for SER is:</p>
<div class="math notranslate nohighlight">
\[\hat{\sigma} = \sqrt{\frac{\sum_{i=1}^{n} e_i^2}{n-k}}\]</div>
<p>where:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(e_i\)</span> is the residual for observation <span class="math notranslate nohighlight">\(i\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(n\)</span> is the number of observations.</p></li>
<li><p><span class="math notranslate nohighlight">\(k\)</span> is the number of parameters estimated in the model.</p></li>
</ul>
<p>Using this single value, <span class="math notranslate nohighlight">\(\hat{\sigma}\)</span>, would mean we assume the error variance is constant across all observations—the definition of <strong>homoscedasticity</strong>. If we were to use this value to calculate weights, every observation would get the same weight, <span class="math notranslate nohighlight">\(w_i = 1/\hat{\sigma}^2\)</span>. This would turn the Weighted Least Squares (WLS) regression back into a standard Ordinary Least Squares (OLS) regression, which completely defeats the purpose of trying to address heteroscedasticity.</p>
</section>
</section>
<section id="additional-materials">
<h2>Additional Materials<a class="headerlink" href="#additional-materials" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.aptech.com/blog/using-feasible-generalized-least-squares-to-improve-estimates/">https://www.aptech.com/blog/using-feasible-generalized-least-squares-to-improve-estimates/</a></p></li>
</ul>
</section>
<section id="code-example-1">
<h2>Code Example 1<a class="headerlink" href="#code-example-1" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>

<span class="c1"># --- 1. Generate Synthetic Data with Heteroscedasticity ---</span>

<span class="c1"># Set a seed for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Generate 500 data points for household income (in thousands of dollars)</span>
<span class="c1"># Income ranges from $20k to $150k</span>
<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>

<span class="c1"># Define the true relationship between income and spending</span>
<span class="c1"># True intercept = 5 (i.e., $5k base spending)</span>
<span class="c1"># True slope = 0.3 (i.e., 30% of income is spent)</span>
<span class="n">true_intercept</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">true_slope</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">true_spending</span> <span class="o">=</span> <span class="n">true_intercept</span> <span class="o">+</span> <span class="n">true_slope</span> <span class="o">*</span> <span class="n">income</span>

<span class="c1"># Introduce heteroscedastic noise</span>
<span class="c1"># The error&#39;s standard deviation increases with income</span>
<span class="c1"># This is the key step to create heteroscedasticity</span>
<span class="n">error_std_dev</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">income</span>  <span class="c1"># Std. dev. is 10% of income</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">error_std_dev</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>

<span class="c1"># Calculate the final, observed spending</span>
<span class="n">observed_spending</span> <span class="o">=</span> <span class="n">true_spending</span> <span class="o">+</span> <span class="n">noise</span>

<span class="c1"># Add a constant (for the intercept) to our predictor variable for statsmodels</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">income</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">20</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[ 1.         20.        ]
 [ 1.         20.26052104]
 [ 1.         20.52104208]
 [ 1.         20.78156313]
 [ 1.         21.04208417]
 [ 1.         21.30260521]
 [ 1.         21.56312625]
 [ 1.         21.82364729]
 [ 1.         22.08416834]
 [ 1.         22.34468938]
 [ 1.         22.60521042]
 [ 1.         22.86573146]
 [ 1.         23.12625251]
 [ 1.         23.38677355]
 [ 1.         23.64729459]
 [ 1.         23.90781563]
 [ 1.         24.16833667]
 [ 1.         24.42885772]
 [ 1.         24.68937876]
 [ 1.         24.9498998 ]]
</pre></div>
</div>
</div>
</div>
<section id="the-intercept-term-in-linear-regression">
<h3>The Intercept Term in Linear Regression<a class="headerlink" href="#the-intercept-term-in-linear-regression" title="Link to this heading">#</a></h3>
<p>In a linear regression model, the relationship between a dependent variable (<span class="math notranslate nohighlight">\(y\)</span>) and an independent variable (<span class="math notranslate nohighlight">\(x\)</span>) is expressed as:</p>
<p><span class="math notranslate nohighlight">\(y = \beta_0 + \beta_1x + \epsilon\)</span></p>
<p>Here, <span class="math notranslate nohighlight">\(\beta_0\)</span> is the <strong>intercept</strong> and <span class="math notranslate nohighlight">\(\beta_1\)</span> is the slope. The intercept (<span class="math notranslate nohighlight">\(\beta_0\)</span>) represents the expected value of <span class="math notranslate nohighlight">\(y\)</span> when <span class="math notranslate nohighlight">\(x\)</span> is zero. In the context of our code, it represents the baseline spending when income is zero. The <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> library, by default, expects you to explicitly include this intercept term as a column of ones in your predictor matrix. This is because it treats the linear model as:</p>
<p><span class="math notranslate nohighlight">\(y = \beta_0 \cdot 1 + \beta_1 \cdot x + \epsilon\)</span></p>
<p>By adding a constant column of ones to your predictor variables, you’re creating a matrix where the first column is a representation of the constant term (1), allowing the model to estimate the coefficient <span class="math notranslate nohighlight">\(\beta_0\)</span>.</p>
</section>
<section id="how-sm-add-constant-works">
<h3>How <code class="docutils literal notranslate"><span class="pre">sm.add_constant</span></code> Works<a class="headerlink" href="#how-sm-add-constant-works" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">sm.add_constant(income)</span></code> function takes the <code class="docutils literal notranslate"><span class="pre">income</span></code> array and adds a new column of ones to the beginning of it.</p>
<ul class="simple">
<li><p><strong>Original <code class="docutils literal notranslate"><span class="pre">income</span></code> array:</strong>
<code class="docutils literal notranslate"><span class="pre">[20,</span> <span class="pre">20.26,</span> <span class="pre">...,</span> <span class="pre">150]</span></code></p></li>
<li><p><strong>After <code class="docutils literal notranslate"><span class="pre">sm.add_constant(income)</span></code>:</strong>
<code class="docutils literal notranslate"><span class="pre">[[1.0,</span> <span class="pre">20],</span> <span class="pre">[1.0,</span> <span class="pre">20.26],</span> <span class="pre">...,</span> <span class="pre">[1.0,</span> <span class="pre">150]]</span></code></p></li>
</ul>
<p>This modified array, named <code class="docutils literal notranslate"><span class="pre">X</span></code>, now has two columns. The first column (all ones) is used to calculate the intercept, while the second column (<code class="docutils literal notranslate"><span class="pre">income</span></code>) is used to calculate the slope. This is why the in the comment to the code we mentioned “(for the intercept)”; it’s explicitly explaining the purpose of adding the constant column.</p>
</section>
<section id="perform-an-initial-ols-regression">
<h3>Perform an Initial OLS Regression<a class="headerlink" href="#perform-an-initial-ols-regression" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- 2. Perform an Initial OLS Regression ---</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Step 1 &amp; 2: Performing OLS and Analyzing Residuals ---&quot;</span><span class="p">)</span>
<span class="c1"># Fit the OLS model</span>
<span class="n">ols_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">observed_spending</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">ols_results</span> <span class="o">=</span> <span class="n">ols_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># Get the OLS predictions and residuals</span>
<span class="n">ols_predictions</span> <span class="o">=</span> <span class="n">ols_results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">ols_residuals</span> <span class="o">=</span> <span class="n">ols_results</span><span class="o">.</span><span class="n">resid</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">OLS Parameter Estimates:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ols_results</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Access the metrics directly from the ols_results object</span>
<span class="n">rss</span> <span class="o">=</span> <span class="n">ols_results</span><span class="o">.</span><span class="n">ssr</span> 
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ols_results</span><span class="o">.</span><span class="n">mse_resid</span><span class="p">)</span> 
<span class="n">ser</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ols_results</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
<span class="n">r_squared</span> <span class="o">=</span> <span class="n">ols_results</span><span class="o">.</span><span class="n">rsquared</span>
<span class="n">adjusted_r_squared</span> <span class="o">=</span> <span class="n">ols_results</span><span class="o">.</span><span class="n">rsquared_adj</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Residual Sum of Squares (RSS): </span><span class="si">{</span><span class="n">rss</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Root Mean Squared Error (RMSE): </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Standard Error of the Regression (SER): </span><span class="si">{</span><span class="n">ser</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R-squared: </span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adjusted R-squared: </span><span class="si">{</span><span class="n">adjusted_r_squared</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># --- Plot OLS Results and Residuals ---</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot 1: OLS Fit</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">observed_spending</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed Data&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">ols_predictions</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;OLS Fit&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;OLS Regression: Spending vs. Income&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Annual Income (in thousands of $)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Annual Spending (in thousands of $)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Plot 2: Residual Plot to show heteroscedasticity</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">ols_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuals vs. Income (OLS)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Annual Income (in thousands of $)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Figure 1: OLS Results Showing Clear Heteroscedasticity&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Step 1 &amp; 2: Performing OLS and Analyzing Residuals ---

OLS Parameter Estimates:
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const          5.2010      1.036      5.019      0.000       3.165       7.237
x1             0.2993      0.011     26.845      0.000       0.277       0.321
==============================================================================
Residual Sum of Squares (RSS): 43755.13
Root Mean Squared Error (RMSE): 9.37
Standard Error of the Regression (SER): 9.37
R-squared: 0.5914
Adjusted R-squared: 0.5905
</pre></div>
</div>
<img alt="../../_images/a67d187ead4bc3903977d851069dd6ddfef30fd266fcf3d07ac1e18f4b46d6da.png" src="../../_images/a67d187ead4bc3903977d851069dd6ddfef30fd266fcf3d07ac1e18f4b46d6da.png" />
</div>
</div>
</section>
<section id="output-analysis">
<h3>Output Analysis<a class="headerlink" href="#output-analysis" title="Link to this heading">#</a></h3>
<p>The parameters <code class="docutils literal notranslate"><span class="pre">t</span></code>, <code class="docutils literal notranslate"><span class="pre">P&gt;|t|</span></code>, and <code class="docutils literal notranslate"><span class="pre">[0.025</span> <span class="pre">0.975]</span></code> are essential for <strong>hypothesis testing</strong> and <strong>confidence interval estimation</strong>. They help us determine if the relationship between our independent and dependent variables is statistically significant.</p>
</section>
<section id="the-t-statistic-t">
<h3>The t-statistic (<span class="math notranslate nohighlight">\(t\)</span>)<a class="headerlink" href="#the-t-statistic-t" title="Link to this heading">#</a></h3>
<p>The <strong>t-statistic</strong> measures how many standard deviations the estimated coefficient is from zero. In other words, it quantifies the evidence against the null hypothesis (<span class="math notranslate nohighlight">\(H_0\)</span>), which states that the true coefficient is zero (i.e., there is no relationship between the independent and dependent variables). A larger absolute value of <span class="math notranslate nohighlight">\(t\)</span> indicates that the coefficient is less likely to be zero by chance.</p>
<div class="math notranslate nohighlight">
\[t = \frac{\text{Estimated Coefficient} - 0}{\text{Standard Error of the Coefficient}}\]</div>
<p>In our output:</p>
<ul class="simple">
<li><p>For the constant (intercept): <span class="math notranslate nohighlight">\(t = \frac{5.2010}{1.036} \approx 5.019\)</span>.</p></li>
<li><p>For the income coefficient (<span class="math notranslate nohighlight">\(x1\)</span>): <span class="math notranslate nohighlight">\(t = \frac{0.2993}{0.011} \approx 26.845\)</span>.</p></li>
</ul>
<p>The very high <span class="math notranslate nohighlight">\(t\)</span>-statistic for income (<span class="math notranslate nohighlight">\(26.845\)</span>) strongly suggests that the slope is not zero, meaning there is a significant relationship between income and spending.</p>
</section>
<section id="the-p-value-p-t">
<h3>The P-value (<span class="math notranslate nohighlight">\(P&gt;|t|\)</span>)<a class="headerlink" href="#the-p-value-p-t" title="Link to this heading">#</a></h3>
<p>The <strong>P-value</strong> is the probability of observing a <span class="math notranslate nohighlight">\(t\)</span>-statistic as extreme as, or more extreme than, the one calculated, assuming the null hypothesis is true. A small P-value provides strong evidence to <strong>reject the null hypothesis</strong>. The common threshold for significance is <span class="math notranslate nohighlight">\(\alpha = 0.05\)</span>. If our P-value is less than 0.05, we can conclude that the coefficient is statistically significant.</p>
<p>In our output:</p>
<ul class="simple">
<li><p>For both the constant and income, the P-values are <strong>0.000</strong>.</p></li>
<li><p>This means the probability of observing these coefficients if there were no real relationship is practically zero. You can confidently reject the null hypothesis and conclude that both the intercept and the effect of income on spending are statistically significant.</p></li>
</ul>
</section>
<section id="the-confidence-interval-0-025-0-975">
<h3>The Confidence Interval ([0.025 0.975])<a class="headerlink" href="#the-confidence-interval-0-025-0-975" title="Link to this heading">#</a></h3>
<p>The <strong>confidence interval</strong> is a range of values that likely contains the true, unknown value of the coefficient. The <code class="docutils literal notranslate"><span class="pre">[0.025</span> <span class="pre">0.975]</span></code> columns represent the <strong>95% confidence interval</strong>, meaning that if you were to repeat our sampling and analysis many times, 95% of the calculated confidence intervals would contain the true population parameter. The key takeaway is to see if this interval includes zero. If the interval does not contain zero, it is further evidence that the coefficient is statistically significant, consistent with a low P-value.</p>
<p>In our output:</p>
<ul class="simple">
<li><p>For the constant <span class="math notranslate nohighlight">\(\beta_0\)</span>: The 95% confidence interval is <code class="docutils literal notranslate"><span class="pre">[3.165,</span> <span class="pre">7.237]</span></code>. Since this range does not contain zero, the intercept is statistically significant.</p></li>
<li><p>For the income coefficient (<span class="math notranslate nohighlight">\(\beta_1\)</span>): The 95% confidence interval is <code class="docutils literal notranslate"><span class="pre">[0.277,</span> <span class="pre">0.321]</span></code>. This range also does not contain zero. This confirms that the true effect of a <span class="math notranslate nohighlight">\(1k increase in income on spending is likely to be between a \)</span>277 and a $321 increase, and it’s highly unlikely to be zero.</p></li>
</ul>
</section>
<section id="estimate-weights-from-ols-residuals">
<h3>Estimate Weights from OLS Residuals<a class="headerlink" href="#estimate-weights-from-ols-residuals" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- 3. Estimate Weights from OLS Residuals ---</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Step 3: Estimating Weights from OLS Residuals ---&quot;</span><span class="p">)</span>
<span class="c1"># The variance seems proportional to income, so we model the absolute residuals vs. income.</span>
<span class="c1"># Using absolute residuals is often more robust.</span>
<span class="n">abs_ols_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ols_residuals</span><span class="p">)</span>

<span class="c1"># Regress absolute residuals on income to estimate the standard deviation</span>
<span class="c1"># This is our variance model</span>
<span class="n">variance_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">abs_ols_residuals</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
<span class="n">variance_results</span> <span class="o">=</span> <span class="n">variance_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># The fitted values from this model are our estimated standard deviations</span>
<span class="n">estimated_std_dev</span> <span class="o">=</span> <span class="n">variance_results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="c1"># The weights are the inverse of the estimated variance</span>
<span class="n">estimated_variance</span> <span class="o">=</span> <span class="n">estimated_std_dev</span><span class="o">**</span><span class="mi">2</span>
<span class="n">weights</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">estimated_variance</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Weights have been calculated based on the variance model.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Step 3: Estimating Weights from OLS Residuals ---
Weights have been calculated based on the variance model.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">40</span><span class="p">])</span>  <span class="c1"># Display the first 40 weights for inspection</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.7853452  0.75496637 0.72631672 0.69926747 0.67370159 0.64951257
 0.62660329 0.60488505 0.58427668 0.56470383 0.54609828 0.52839731
 0.51154322 0.49548285 0.48016711 0.46555068 0.45159163 0.43825111
 0.42549312 0.41328423 0.40159337 0.39039165 0.37965215 0.36934979
 0.35946116 0.3499644  0.34083908 0.33206607 0.32362748 0.31550651
 0.30768743 0.30015545 0.29289669 0.28589809 0.27914737 0.27263296
 0.26634395 0.26027007 0.25440162 0.24872943]
</pre></div>
</div>
</div>
</div>
</section>
<section id="perform-the-final-wls-regression">
<h3>Perform the Final WLS Regression<a class="headerlink" href="#perform-the-final-wls-regression" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- 4. Perform the Final WLS Regression ---</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Step 4: Performing WLS Regression with Calculated Weights ---&quot;</span><span class="p">)</span>
<span class="c1"># Fit the WLS model using the calculated weights</span>
<span class="n">wls_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">WLS</span><span class="p">(</span><span class="n">observed_spending</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
<span class="n">wls_results</span> <span class="o">=</span> <span class="n">wls_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># Get the WLS predictions</span>
<span class="n">wls_predictions</span> <span class="o">=</span> <span class="n">wls_results</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WLS Parameter Estimates:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">wls_results</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># Access the metrics directly from the wls_results object</span>
<span class="n">wls_rss</span> <span class="o">=</span> <span class="n">wls_results</span><span class="o">.</span><span class="n">ssr</span> 
<span class="n">wls_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wls_results</span><span class="o">.</span><span class="n">mse_resid</span><span class="p">)</span> 
<span class="n">wls_ser</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wls_results</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
<span class="n">wls_r_squared</span> <span class="o">=</span> <span class="n">wls_results</span><span class="o">.</span><span class="n">rsquared</span>
<span class="n">wls_adjusted_r_squared</span> <span class="o">=</span> <span class="n">wls_results</span><span class="o">.</span><span class="n">rsquared_adj</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WLS Residual Sum of Squares (RSS): </span><span class="si">{</span><span class="n">wls_rss</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WLS Root Mean Squared Error (RMSE): </span><span class="si">{</span><span class="n">wls_rmse</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WLS Standard Error of the Regression (SER): </span><span class="si">{</span><span class="n">wls_ser</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WLS R-squared: </span><span class="si">{</span><span class="n">wls_r_squared</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WLS Adjusted R-squared: </span><span class="si">{</span><span class="n">wls_adjusted_r_squared</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># --- 5. Visualize and Compare OLS and WLS Results ---</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="c1"># Plot 1: Comparison of OLS and WLS fits</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">observed_spending</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed Data&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">ols_predictions</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;OLS Fit&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">wls_predictions</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;WLS Fit&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Comparison of OLS and WLS Fits&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Annual Income (in thousands of $)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Annual Spending (in thousands of $)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Plot 2: WLS Residuals (now should be homoscedastic)</span>
<span class="c1"># WLS residuals are weighted residuals, but it&#39;s more intuitive to plot standardized residuals</span>
<span class="n">wls_standardized_residuals</span> <span class="o">=</span> <span class="n">wls_results</span><span class="o">.</span><span class="n">resid</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">estimated_variance</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">wls_standardized_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Standardized Residuals vs. Income (WLS)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Annual Income (in thousands of $)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Standardized Residuals&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Figure 2: WLS Results and Comparison&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Step 4: Performing WLS Regression with Calculated Weights ---

WLS Parameter Estimates:
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
const          4.5562      0.397     11.490      0.000       3.777       5.335
x1             0.3076      0.008     37.805      0.000       0.292       0.324
==============================================================================
WLS Residual Sum of Squares (RSS): 816.31
WLS Root Mean Squared Error (RMSE): 1.28
WLS Standard Error of the Regression (SER): 1.28
WLS R-squared: 0.7416
WLS Adjusted R-squared: 0.7411
</pre></div>
</div>
<img alt="../../_images/ad3b19acae219d8b017f20157fbc061ec628c4caa1d148a95363d5d14e76bcc8.png" src="../../_images/ad3b19acae219d8b017f20157fbc061ec628c4caa1d148a95363d5d14e76bcc8.png" />
</div>
</div>
<p>NOTE: Compare the results of WLS and OLS to see that WLS provided us with more accurate results.</p>
</section>
</section>
<section id="example-2">
<h2>Example 2<a class="headerlink" href="#example-2" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>

<span class="c1"># --- 1. Generate Synthetic Data with Heteroscedasticity ---</span>
<span class="c1"># This part is identical to the previous example.</span>

<span class="c1"># Set a seed for reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Generate 500 data points for household income (in thousands of dollars)</span>
<span class="n">n_samples</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>

<span class="c1"># Define the true relationship between income and spending</span>
<span class="n">true_intercept</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">true_slope</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="c1"># The function we want to fit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">linear_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">slope</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A simple linear model function for curve_fit.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x</span>

<span class="c1"># Calculate the &quot;true&quot; spending based on the model</span>
<span class="n">true_spending</span> <span class="o">=</span> <span class="n">linear_model</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">true_intercept</span><span class="p">,</span> <span class="n">true_slope</span><span class="p">)</span>

<span class="c1"># Introduce heteroscedastic noise (error&#39;s standard deviation increases with income)</span>
<span class="n">error_std_dev</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">income</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">error_std_dev</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>

<span class="c1"># Calculate the final, observed spending</span>
<span class="n">observed_spending</span> <span class="o">=</span> <span class="n">true_spending</span> <span class="o">+</span> <span class="n">noise</span>


<span class="c1"># --- 2. Perform an Initial &quot;OLS&quot; Fit using curve_fit ---</span>
<span class="c1"># An unweighted fit in curve_fit is equivalent to an OLS fit.</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Step 1 &amp; 2: Performing Unweighted Fit (OLS) and Analyzing Residuals ---&quot;</span><span class="p">)</span>

<span class="c1"># Perform the fit without providing sigma</span>
<span class="n">popt_ols</span><span class="p">,</span> <span class="n">pcov_ols</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">linear_model</span><span class="p">,</span> <span class="n">income</span><span class="p">,</span> <span class="n">observed_spending</span><span class="p">)</span>
<span class="n">perr_ols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov_ols</span><span class="p">))</span> <span class="c1"># Standard errors of the parameters</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">OLS Parameter Estimates:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Intercept: </span><span class="si">{</span><span class="n">popt_ols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">perr_ols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Slope:     </span><span class="si">{</span><span class="n">popt_ols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">perr_ols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># NOTE: These standard errors are less reliable because heteroscedasticity is present.</span>

<span class="c1"># Calculate predictions and residuals</span>
<span class="n">ols_predictions</span> <span class="o">=</span> <span class="n">linear_model</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="o">*</span><span class="n">popt_ols</span><span class="p">)</span>
<span class="n">ols_residuals</span> <span class="o">=</span> <span class="n">observed_spending</span> <span class="o">-</span> <span class="n">ols_predictions</span>


<span class="c1"># --- Plot OLS Results and Residuals ---</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-v0_8-whitegrid&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot 1: OLS Fit</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">observed_spending</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed Data&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">ols_predictions</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Unweighted Fit (OLS)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Unweighted Fit: Spending vs. Income&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Annual Income (in thousands of $)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Annual Spending (in thousands of $)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Plot 2: Residual Plot to show heteroscedasticity</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">ols_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Residuals vs. Income (Unweighted Fit)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Annual Income (in thousands of $)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Figure 1: `curve_fit` Unweighted Results Showing Heteroscedasticity&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># --- 3. Estimate Sigma (Standard Deviation) from OLS Residuals ---</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Step 3: Estimating Sigma from Residuals ---&quot;</span><span class="p">)</span>
<span class="c1"># Model the standard deviation as a linear function of income.</span>
<span class="c1"># We fit this model to the absolute values of the OLS residuals.</span>
<span class="n">abs_ols_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ols_residuals</span><span class="p">)</span>

<span class="c1"># Fit a model to estimate the standard deviation</span>
<span class="n">popt_var</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">linear_model</span><span class="p">,</span> <span class="n">income</span><span class="p">,</span> <span class="n">abs_ols_residuals</span><span class="p">)</span>

<span class="c1"># The predictions from this fit are our estimated sigma values</span>
<span class="n">estimated_sigma</span> <span class="o">=</span> <span class="n">linear_model</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="o">*</span><span class="n">popt_var</span><span class="p">)</span>
<span class="c1"># Ensure sigma is not negative (can happen with linear models at extremes)</span>
<span class="n">estimated_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">estimated_sigma</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">)</span> 

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sigma for each data point has been estimated based on the residuals.&quot;</span><span class="p">)</span>

<span class="c1"># --- 4. Perform the Final &quot;WLS&quot; Fit using curve_fit ---</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Step 4: Performing Weighted Fit (WLS) with Estimated Sigma ---&quot;</span><span class="p">)</span>
<span class="c1"># Now, we pass the estimated sigma to curve_fit.</span>
<span class="c1"># `absolute_sigma=True` is crucial. It tells curve_fit that our sigma values are</span>
<span class="c1"># the absolute standard deviations, which are used to calculate weights (1/sigma**2).</span>
<span class="c1"># This also ensures the covariance matrix pcov is calculated correctly.</span>
<span class="n">popt_wls</span><span class="p">,</span> <span class="n">pcov_wls</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">linear_model</span><span class="p">,</span> <span class="n">income</span><span class="p">,</span> <span class="n">observed_spending</span><span class="p">,</span>
                               <span class="n">sigma</span><span class="o">=</span><span class="n">estimated_sigma</span><span class="p">,</span>
                               <span class="n">absolute_sigma</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">perr_wls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov_wls</span><span class="p">))</span> <span class="c1"># More reliable standard errors</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">WLS Parameter Estimates:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Intercept: </span><span class="si">{</span><span class="n">popt_wls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">perr_wls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Slope:     </span><span class="si">{</span><span class="n">popt_wls</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">perr_wls</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Calculate WLS predictions</span>
<span class="n">wls_predictions</span> <span class="o">=</span> <span class="n">linear_model</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="o">*</span><span class="n">popt_wls</span><span class="p">)</span>


<span class="c1"># --- 5. Visualize and Compare OLS and WLS Results ---</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="c1"># Plot 1: Comparison of OLS and WLS fits</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">observed_spending</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Observed Data&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">ols_predictions</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Unweighted Fit (OLS)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">wls_predictions</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Weighted Fit (WLS)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Comparison of Unweighted and Weighted Fits&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Annual Income (in thousands of $)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Annual Spending (in thousands of $)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Plot 2: WLS Standardized Residuals</span>
<span class="c1"># These are the raw residuals divided by their estimated sigma.</span>
<span class="c1"># They should now have a constant variance (i.e., be homoscedastic).</span>
<span class="n">wls_standardized_residuals</span> <span class="o">=</span> <span class="p">(</span><span class="n">observed_spending</span> <span class="o">-</span> <span class="n">wls_predictions</span><span class="p">)</span> <span class="o">/</span> <span class="n">estimated_sigma</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">wls_standardized_residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Standardized Residuals vs. Income (WLS)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Annual Income (in thousands of $)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Standardized Residuals&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Figure 2: `curve_fit` WLS Results and Comparison&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Step 1 &amp; 2: Performing Unweighted Fit (OLS) and Analyzing Residuals ---

OLS Parameter Estimates:
  Intercept: 5.2010 +/- 1.0362
  Slope:     0.2993 +/- 0.0111
</pre></div>
</div>
<img alt="../../_images/e83675d2abb01e62bb0a4ee46c8c3fd254f458c7e065d642f71c4ea476fd06c8.png" src="../../_images/e83675d2abb01e62bb0a4ee46c8c3fd254f458c7e065d642f71c4ea476fd06c8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Step 3: Estimating Sigma from Residuals ---
Sigma for each data point has been estimated based on the residuals.

--- Step 4: Performing Weighted Fit (WLS) with Estimated Sigma ---

WLS Parameter Estimates:
  Intercept: 4.5562 +/- 0.3097
  Slope:     0.3076 +/- 0.0064
</pre></div>
</div>
<img alt="../../_images/701df4393dd6872ac9004a7031843aced0d24ebeb0cdcf232964f27fcf3a9ddd.png" src="../../_images/701df4393dd6872ac9004a7031843aced0d24ebeb0cdcf232964f27fcf3a9ddd.png" />
</div>
</div>
</section>
<section id="example-3">
<h2>Example 3<a class="headerlink" href="#example-3" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">r2_score</span>

<span class="c1"># --- 1. Define Functions ---</span>

<span class="k">def</span><span class="w"> </span><span class="nf">custom_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The custom non-linear function to approximate the data.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">B</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">100</span>

<span class="k">def</span><span class="w"> </span><span class="nf">variance_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A simple linear model to estimate the standard deviation from residuals.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">b</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_metrics</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">num_params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function to calculate common fit metrics.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rss</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rss</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">num_params</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r_squared</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">r_squared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">num_params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">r_squared</span><span class="p">):</span>
        <span class="n">adj_r_squared</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r_squared</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">num_params</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adj_r_squared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;rss&quot;</span><span class="p">:</span> <span class="n">rss</span><span class="p">,</span> <span class="s2">&quot;rmse&quot;</span><span class="p">:</span> <span class="n">rmse</span><span class="p">,</span> <span class="s2">&quot;ser&quot;</span><span class="p">:</span> <span class="n">ser</span><span class="p">,</span>
        <span class="s2">&quot;r_squared&quot;</span><span class="p">:</span> <span class="n">r_squared</span><span class="p">,</span> <span class="s2">&quot;adj_r_squared&quot;</span><span class="p">:</span> <span class="n">adj_r_squared</span>
    <span class="p">}</span>

<span class="c1"># --- 2. Prepare the Datasets ---</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Dataset 1&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">97</span><span class="p">]),</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mf">79.7</span><span class="p">,</span> <span class="mf">51.3</span><span class="p">,</span> <span class="mf">44.6</span><span class="p">,</span> <span class="mf">39.8</span><span class="p">,</span> <span class="mf">29.9</span><span class="p">,</span> <span class="mf">10.3</span><span class="p">])},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Dataset 2&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">294</span><span class="p">,</span> <span class="mi">391</span><span class="p">]),</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mf">80.4</span><span class="p">,</span> <span class="mf">66.4</span><span class="p">,</span> <span class="mf">50.1</span><span class="p">,</span> <span class="mf">41.2</span><span class="p">,</span> <span class="mf">28.5</span><span class="p">,</span> <span class="mf">20.1</span><span class="p">])},</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Dataset 3&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">292</span><span class="p">,</span> <span class="mi">401</span><span class="p">]),</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mf">87.8</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mf">65.7</span><span class="p">,</span> <span class="mf">50.9</span><span class="p">,</span> <span class="mf">46.5</span><span class="p">,</span> <span class="mf">44.4</span><span class="p">])},</span>
<span class="p">]</span>

<span class="c1"># --- 3. Perform Full WLS Analysis for Each Dataset ---</span>
<span class="n">all_results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="s2"> Analyzing </span><span class="si">{</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">20</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]</span>
    
    <span class="c1"># ======================================================================</span>
    <span class="c1"># STAGE 1: Unweighted Non-Linear Least Squares (NLLS)</span>
    <span class="c1"># ======================================================================</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- STAGE 1: Performing Unweighted Fit (NLLS) ---&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">popt_nlls</span><span class="p">,</span> <span class="n">pcov_nlls</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">custom_function</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">initial_guess</span><span class="p">)</span>
        <span class="n">perr_nlls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov_nlls</span><span class="p">))</span>
        <span class="n">y_pred_nlls</span> <span class="o">=</span> <span class="n">custom_function</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="o">*</span><span class="n">popt_nlls</span><span class="p">)</span>
        <span class="n">residuals_nlls</span> <span class="o">=</span> <span class="n">y_data</span> <span class="o">-</span> <span class="n">y_pred_nlls</span>
        <span class="n">metrics_nlls</span> <span class="o">=</span> <span class="n">calculate_metrics</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">y_pred_nlls</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">popt_nlls</span><span class="p">))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unweighted Parameters: A=</span><span class="si">{</span><span class="n">popt_nlls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">±</span><span class="si">{</span><span class="n">perr_nlls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, B=</span><span class="si">{</span><span class="n">popt_nlls</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">±</span><span class="si">{</span><span class="n">perr_nlls</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unweighted Metrics:    Adj. R²=</span><span class="si">{</span><span class="n">metrics_nlls</span><span class="p">[</span><span class="s1">&#39;adj_r_squared&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SER=</span><span class="si">{</span><span class="n">metrics_nlls</span><span class="p">[</span><span class="s1">&#39;ser&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not perform unweighted fit for </span><span class="si">{</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="c1"># ======================================================================</span>
    <span class="c1"># STAGE 2: Weighted Non-Linear Least Squares (WNLLS)</span>
    <span class="c1"># ======================================================================</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- STAGE 2: Estimating Weights and Performing Weighted Fit (WNLLS) ---&quot;</span><span class="p">)</span>
    <span class="n">abs_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">residuals_nlls</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">popt_var</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">variance_model</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">abs_residuals</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">estimated_sigma</span> <span class="o">=</span> <span class="n">variance_model</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="o">*</span><span class="n">popt_var</span><span class="p">)</span>
        <span class="n">estimated_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">estimated_sigma</span><span class="p">)</span>

        <span class="n">popt_wls</span><span class="p">,</span> <span class="n">pcov_wls</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span>
            <span class="n">custom_function</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span>
            <span class="n">p0</span><span class="o">=</span><span class="n">popt_nlls</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">estimated_sigma</span><span class="p">,</span>
            <span class="n">absolute_sigma</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">perr_wls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">pcov_wls</span><span class="p">))</span>
        <span class="n">y_pred_wls</span> <span class="o">=</span> <span class="n">custom_function</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="o">*</span><span class="n">popt_wls</span><span class="p">)</span>
        <span class="n">metrics_wls</span> <span class="o">=</span> <span class="n">calculate_metrics</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">y_pred_wls</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">popt_wls</span><span class="p">))</span>
        <span class="n">standardized_residuals_wls</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_data</span> <span class="o">-</span> <span class="n">y_pred_wls</span><span class="p">)</span> <span class="o">/</span> <span class="n">estimated_sigma</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weighted Parameters: A=</span><span class="si">{</span><span class="n">popt_wls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">±</span><span class="si">{</span><span class="n">perr_wls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, B=</span><span class="si">{</span><span class="n">popt_wls</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">±</span><span class="si">{</span><span class="n">perr_wls</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weighted Metrics:    Adj. R²=</span><span class="si">{</span><span class="n">metrics_wls</span><span class="p">[</span><span class="s1">&#39;adj_r_squared&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, SER=</span><span class="si">{</span><span class="n">metrics_wls</span><span class="p">[</span><span class="s1">&#39;ser&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;x_data&quot;</span><span class="p">:</span> <span class="n">x_data</span><span class="p">,</span> <span class="s2">&quot;y_data&quot;</span><span class="p">:</span> <span class="n">y_data</span><span class="p">,</span>
            <span class="s2">&quot;popt_nlls&quot;</span><span class="p">:</span> <span class="n">popt_nlls</span><span class="p">,</span> <span class="s2">&quot;perr_nlls&quot;</span><span class="p">:</span> <span class="n">perr_nlls</span><span class="p">,</span> <span class="s2">&quot;y_pred_nlls&quot;</span><span class="p">:</span> <span class="n">y_pred_nlls</span><span class="p">,</span>
            <span class="s2">&quot;residuals_nlls&quot;</span><span class="p">:</span> <span class="n">residuals_nlls</span><span class="p">,</span> <span class="s2">&quot;metrics_nlls&quot;</span><span class="p">:</span> <span class="n">metrics_nlls</span><span class="p">,</span>
            <span class="s2">&quot;popt_wls&quot;</span><span class="p">:</span> <span class="n">popt_wls</span><span class="p">,</span> <span class="s2">&quot;perr_wls&quot;</span><span class="p">:</span> <span class="n">perr_wls</span><span class="p">,</span> <span class="s2">&quot;y_pred_wls&quot;</span><span class="p">:</span> <span class="n">y_pred_wls</span><span class="p">,</span>
            <span class="s2">&quot;standardized_residuals_wls&quot;</span><span class="p">:</span> <span class="n">standardized_residuals_wls</span><span class="p">,</span> <span class="s2">&quot;metrics_wls&quot;</span><span class="p">:</span> <span class="n">metrics_wls</span><span class="p">,</span>
        <span class="p">})</span>
        
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not perform weighted fit for </span><span class="si">{</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">all_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;x_data&quot;</span><span class="p">:</span> <span class="n">x_data</span><span class="p">,</span> <span class="s2">&quot;y_data&quot;</span><span class="p">:</span> <span class="n">y_data</span><span class="p">,</span>
            <span class="s2">&quot;popt_nlls&quot;</span><span class="p">:</span> <span class="n">popt_nlls</span><span class="p">,</span> <span class="s2">&quot;perr_nlls&quot;</span><span class="p">:</span> <span class="n">perr_nlls</span><span class="p">,</span> <span class="s2">&quot;y_pred_nlls&quot;</span><span class="p">:</span> <span class="n">y_pred_nlls</span><span class="p">,</span>
            <span class="s2">&quot;residuals_nlls&quot;</span><span class="p">:</span> <span class="n">residuals_nlls</span><span class="p">,</span> <span class="s2">&quot;metrics_nlls&quot;</span><span class="p">:</span> <span class="n">metrics_nlls</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;WLS Fit Failed&quot;</span>
        <span class="p">})</span>

<span class="c1"># --- 4. Plotting the Results ---</span>
<span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">all_results</span><span class="p">:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analysis of </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
    <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x_data&quot;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;y_data&quot;</span><span class="p">]</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Original Data&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">x_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_data</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_data</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
    
    <span class="n">y_plot_nlls</span> <span class="o">=</span> <span class="n">custom_function</span><span class="p">(</span><span class="n">x_plot</span><span class="p">,</span> <span class="o">*</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;popt_nlls&#39;</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_plot</span><span class="p">,</span> <span class="n">y_plot_nlls</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unweighted Fit (Adj R²=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;metrics_nlls&#39;</span><span class="p">][</span><span class="s1">&#39;adj_r_squared&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;popt_wls&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
        <span class="n">y_plot_wls</span> <span class="o">=</span> <span class="n">custom_function</span><span class="p">(</span><span class="n">x_plot</span><span class="p">,</span> <span class="o">*</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;popt_wls&#39;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_plot</span><span class="p">,</span> <span class="n">y_plot_wls</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Weighted Fit (Adj R²=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;metrics_wls&#39;</span><span class="p">][</span><span class="s1">&#39;adj_r_squared&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fit Comparison&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;residuals_nlls&#39;</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Unweighted Fit Residuals&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Residual (y - ŷ)&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;standardized_residuals_wls&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;standardized_residuals_wls&#39;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Weighted Fit Standardized Residuals&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;WLS Fit Failed&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Weighted Residuals&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Standardized Residual&quot;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==================== Analyzing Dataset 1 ====================

--- STAGE 1: Performing Unweighted Fit (NLLS) ---
Unweighted Parameters: A=93.54±7.62, B=0.0270±0.0048
Unweighted Metrics:    Adj. R²=0.9757, SER=4.7146

--- STAGE 2: Estimating Weights and Performing Weighted Fit (WNLLS) ---
Weighted Parameters: A=95.23±4.65, B=0.0259±0.0028
Weighted Metrics:    Adj. R²=0.9755, SER=4.7356

==================== Analyzing Dataset 2 ====================

--- STAGE 1: Performing Unweighted Fit (NLLS) ---
Unweighted Parameters: A=75.30±4.36, B=0.0110±0.0020
Unweighted Metrics:    Adj. R²=0.9674, SER=5.1805

--- STAGE 2: Estimating Weights and Performing Weighted Fit (WNLLS) ---
Weighted Parameters: A=72.63±3.20, B=0.0124±0.0015
Weighted Metrics:    Adj. R²=0.9649, SER=5.3696

==================== Analyzing Dataset 3 ====================

--- STAGE 1: Performing Unweighted Fit (NLLS) ---
Unweighted Parameters: A=56.68±0.54, B=0.0099±0.0003
Unweighted Metrics:    Adj. R²=0.9992, SER=0.6015

--- STAGE 2: Estimating Weights and Performing Weighted Fit (WNLLS) ---
Weighted Parameters: A=56.65±0.16, B=0.0100±0.0002
Weighted Metrics:    Adj. R²=0.9992, SER=0.6016
</pre></div>
</div>
<img alt="../../_images/9e190302cba7aa65e1c8e7555ca42d19290c13e925d3db759b7bc29394684ebd.png" src="../../_images/9e190302cba7aa65e1c8e7555ca42d19290c13e925d3db759b7bc29394684ebd.png" />
<img alt="../../_images/02817a7939d4bb34fe072d29e9a0f1cc044ff88102f0975e801613e0244a4ae4.png" src="../../_images/02817a7939d4bb34fe072d29e9a0f1cc044ff88102f0975e801613e0244a4ae4.png" />
<img alt="../../_images/8dde57a0a2f78e1611e020c7288e400ec75ce2c3be936b1d13ef16bdc9d2d7c1.png" src="../../_images/8dde57a0a2f78e1611e020c7288e400ec75ce2c3be936b1d13ef16bdc9d2d7c1.png" />
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./math\01_basics"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="weighted-least-squares.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Weighted Least Squares</p>
      </div>
    </a>
    <a class="right-next"
       href="goodness-of-fit-and-chi-squared.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Goodness of Fit and Chi-Squared Statistic</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-note-on-estimating-weights-when-true-variance-is-unknown">A Note on Estimating Weights When True Variance is Unknown</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-multi-step-procedure-for-estimating-weights-for-linear-problem">The Multi-Step Procedure for Estimating Weights for Linear Problem</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-modeling-household-spending">Example: Modeling Household Spending</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-we-don-t-use-a-single-ser">Why We Don’t Use a Single SER</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-materials">Additional Materials</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#code-example-1">Code Example 1</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-intercept-term-in-linear-regression">The Intercept Term in Linear Regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#how-sm-add-constant-works">How <code class="docutils literal notranslate"><span class="pre">sm.add_constant</span></code> Works</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#perform-an-initial-ols-regression">Perform an Initial OLS Regression</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#output-analysis">Output Analysis</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-t-statistic-t">The t-statistic (<span class="math notranslate nohighlight">\(t\)</span>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-p-value-p-t">The P-value (<span class="math notranslate nohighlight">\(P&gt;|t|\)</span>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-confidence-interval-0-025-0-975">The Confidence Interval ([0.025 0.975])</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimate-weights-from-ols-residuals">Estimate Weights from OLS Residuals</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#perform-the-final-wls-regression">Perform the Final WLS Regression</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2">Example 2</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3">Example 3</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Vladyslav Yakovliev
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>